name: Deploy Backend

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout
        uses: actions/checkout@v3

      # 2. 登录 阿里云ACR
      - name: Login to Aliyun ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }} # 指定阿里云地址
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # 格式：registry地址/命名空间/镜像名:版本
          tags: ${{ secrets.ALIYUN_REGISTRY }}/bq-project-space/stock-flow:latest

      # 4. 部署到阿里云
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. 显式登录阿里云 ACR (防止权限过期)
            # 这里的 secrets 必须和你 GitHub 仓库里配的一样
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin ${{ secrets.ALIYUN_REGISTRY }}
            mkdir -p /data/my-project
            cd /data/my-project

            # 停止容器
            docker compose down

            # --- 这里是关键修改点 ---
            # 重新写入 docker-compose.yml，必须确保这里的 image 地址是阿里云的
            cat <<EOF > docker-compose.yml
            services:
              db:
                image: mysql:5.7
                restart: always
                container_name: app_db
                environment:
                  MYSQL_ROOT_PASSWORD: stock_flow_db123456 # 记得在 Secrets 里配，或者这里先写死
                  MYSQL_DATABASE: stock-flow
                volumes:
                  - ./mysql_data:/var/lib/mysql
                networks:
                  - app_network
                  
              backend:
                # ⬇️⬇️⬇️ 重点看这里！必须改成阿里云的完整地址 ⬇️⬇️⬇️
                # 格式：registry.cn-hangzhou.aliyuncs.com/命名空间/仓库名:latest
                image: ${{ secrets.ALIYUN_REGISTRY }}/bq-project-space/stock-flow:latest
                # ⬆️⬆️⬆️ 确认这里不再是 DOCKERHUB_USERNAME
                
                restart: always
                container_name: app_backend
                ports:
                  - "8080:8080"
                depends_on:
                  - db
                environment:
                  DB_HOST: db
                  DB_PORT: 3306
                  DB_USER: root
                  DB_PASSWORD: stock_flow_db123456
                  DB_NAME: stock_flow
                networks:
                  - app_network
            networks:
              app_network:
                driver: bridge
            EOF
            # --- 修改结束 ---

            # 登录阿里云 ACR (防止服务器没权限拉取)
            # 注意：这里需要把你的密码 echo 进去，或者在服务器手动登录一次
            # 最简单的办法是：在服务器上手动执行一次 `docker login registry.cn-hangzhou.aliyuncs.com`
            # 这样凭证会保存在服务器上，以后 Actions 就不需要这两行了。
            
            docker compose pull
            docker compose up -d