# 综合统计接口开发计划

## 1. 业务逻辑层 (Services)

新建 `StatisticsService` 结构体，封装所有统计逻辑。

* **GetTotalInventoryBatches**: 统计当前库存总批次数量。

  * 过滤条件：`current_qty > 0` 且未逻辑删除（GORM默认）。

* **GetWarningInventoryBatches**: 统计临期预警库存。

  * 逻辑：遍历库存，计算 `expiry_date` 与当前时间的差值。

  * 优化：利用SQL直接筛选 `expiry_date <= DATE_ADD(NOW(), INTERVAL expiry_alert_days DAY) AND expiry_date > NOW()`。

  * 注意：需关联 `wms_materials` 表获取 `expiry_alert_days`。

* **GetExpiredInventoryBatches**: 统计已过期库存。

  * 逻辑：`expiry_date <= NOW() AND current_qty > 0`。

* **GetOutboundStats**: 近半年耗材出库统计。

  * 逻辑：

    * 时间范围：过去6个月。

    * 分组：按 `DATE_FORMAT(created_at, '%Y-%m')`。

    * 统计：`SUM(quantity)`。

    * 状态：仅统计已审批通过 (`approval_status = 'APPROVED'`) 的记录。

## 2. 数据访问层 (DAO)

在 `InventoryDao` 和 `OutboundDao` 中添加专用统计方法，或新建 `StatisticsDao`。鉴于功能独立性，建议新建 `internal/dao/statistics_dao.go`。

* **CountTotalBatches**: `SELECT COUNT(*) FROM wms_inventory WHERE current_qty > 0`

* **CountWarningBatches**:

  ```sql
  SELECT wms_inventory.id, wms_inventory.batch_no, wms_materials.name, wms_materials.expiry_alert_days, wms_inventory.expiry_date
  FROM wms_inventory
  JOIN wms_materials ON wms_inventory.material_id = wms_materials.id
  WHERE wms_inventory.current_qty > 0
  AND wms_inventory.expiry_date <= DATE_ADD(NOW(), INTERVAL wms_materials.expiry_alert_days DAY)
  AND wms_inventory.expiry_date > NOW()
  ```

* **CountExpiredBatches**: `SELECT COUNT(*) FROM wms_inventory WHERE current_qty > 0 AND expiry_date <= NOW()`

* **GetOutboundTrend**:

  ```sql
  SELECT DATE_FORMAT(created_at, '%Y-%m') as month, SUM(quantity) as total_qty
  FROM wms_outbound
  WHERE created_at >= ? AND approval_status = 'APPROVED'
  GROUP BY month
  ORDER BY month ASC
  ```

## 3. 控制器层 (Controllers)

新建 `StatisticsController`。

* **GetDashboardStats**: 聚合上述所有统计数据，一次性返回或分接口返回。鉴于需求是"一个综合统计接口"，建议设计为 `/api/v1/statistics/dashboard`。

## 4. 路由配置 (Router)

* 在 `internal/routers/router.go` 中注册 `/api/v1/statistics/dashboard`。

* 权限：仅限 `Admin` 和 `Keeper` 访问。

## 5. 接口定义 (Swagger)

* 定义请求/响应结构体。

* 更新 Swagger 文档。

## 6. 测试

* 编写单元测试覆盖核心统计逻辑。

