医疗耗材全生命周期管理系统 (LIMS-Consumable) 产品需求文档
1. 项目背景与目标
1.1 项目背景
当前耗材管理依赖Excel线下维护，存在以下痛点：

库存数据滞后：领用与扣减不实时，导致账实不符。

效期监管困难：无法自动预警临期耗材，存在误用过期试剂（如TSA培养基）的风险。

追溯成本高：难以快速查询某一批次耗材的流向及具体使用人。

1.2 核心目标
构建一套基于Web的耗材管理系统，实现：

精准库存：支持Excel批量导入入库，实时领用扣减。

效期强控：建立“红绿灯”效期预警机制，优先推荐近效期产品（FEFO原则）。

全流程闭环：从入库 -> 领用 -> 消耗/归还的全链路记录。
2. 角色与权限体系 (RBAC)
角色,标识,权限描述,核心页面
系统管理员,Admin,全局配置、账号管理、数据修正。,用户管理、系统设置
库管员,Keeper,负责耗材入库（导入）、盘点、效期监控、报表导出。,库存总表、入库管理
普通用户,User,负责查询库存、申请领用、更新耗材使用状态。,领出总表、领用申请
3. 业务流程设计
graph TD
    subgraph 库管员
    A[Excel整理入库单] --> B[系统批量导入]
    B --> C{数据校验}
    C -->|失败| D[返回错误行与原因]
    C -->|成功| E[生成库存批次记录]
    end

    subgraph 系统逻辑
    E --> F[监控有效期]
    F -->|剩余<60天| G[标记为预警状态]
    F -->|已过期| H[冻结库存/禁止领用]
    end

    subgraph 普通用户
    I[查询耗材] --> J{库存是否充足?}
    J -->|否| K[无法领用]
    J -->|是| L[发起领用申请]
    L --> M[填写用途/数量]
    end

    subgraph 数据变更
    M --> N[生成领出单]
    N --> O[扣减对应批次库存]
    O --> P[生成领出记录(使用中)]
    P --> Q[用户后续反馈(已用完)]
    ```

---

## 4. 功能模块详细设计

### 4.1 用户登录模块
* **功能点**：账号密码登录、退出、记住密码。
* **逻辑**：
    * 用户状态分为 `正常` / `禁用`。
    * 登录成功后，根据角色自动跳转至不同首页（库管员->库存看板；普通用户->领用记录）。

### 4.2 耗材入库管理 (基于截图1)

#### 4.2.1 批量导入 (Excel Import)
* **前置条件**：库管员权限。
* **交互流程**：
    1.  点击“导入库存”按钮。
    2.  下载系统提供的标准模板（`.xlsx`）。
    3.  上传文件，前端解析并展示预览表格。
    4.  **数据清洗规则**：
        * `物料编码`：必填，作为关联基础信息的Key。
        * `自身有效期到期日`：必填，格式必须为 `YYYY-MM-DD`。
        * `数量`：必须为正整数。
        * `内部批号`：系统内查重，同一物料编码下，若批号已存在，提示“追加数量”或“覆盖”。
    5.  确认提交，写入数据库。

#### 4.2.2 库存总表 (Inventory List)
* **页面展示**：对应截图1的字段。
* **查询条件**：物料名称(模糊)、物料编码、内部批号、**过期状态(筛选)**。
* **字段定义与映射**：
    | 页面字段 | 数据库字段建议 | 说明 |
    | :--- | :--- | :--- |
    | 物料编码 | `material_code` | 核心索引 |
    | 入库单号 | `inbound_no` | 追踪来源 |
    | 物料类型 | `category` | 如：培养基、玻璃器皿 |
    | 物料名称 | `name` | |
    | 规格 | `spec` | 如：250g/瓶 |
    | 数量 | `total_qty` | 初始入库数量 |
    | 单位 | `unit` | 瓶、个 |
    | 厂家/品牌 | `brand` | |
    | 内部批号 | `batch_no` | **管控核心**，区分不同批次 |
    | 当前库存 | `current_qty` | **动态变化**，随领用减少 |
    | 有效期 | `expiry_date` | 决定状态颜色 |
    | 备注 | `remark` | |

* **视觉交互 (效期预警)**：
    * 🔴 **已过期**：`当前日期 > 有效期`，行背景淡红，操作列仅显示“报废/处理”。
    * 🟡 **临期预警**：`当前日期 + 预警阈值(如60天) > 有效期`，行背景淡黄，文字提示“即将过期”。
    * 🟢 **正常**：其他情况。

### 4.3 耗材领用管理 (基于截图2)

#### 4.3.1 领用申请 (购物车/直接领用)
* **交互流程**：
    1.  用户在“库存列表”点击“领用”。
    2.  弹窗显示该物料的所有批次信息。
    3.  **智能推荐**：系统自动高亮显示“有效期最早且库存>0”的批次（FEFO策略），提示用户优先领取此批次。
    4.  用户输入`领出数量`（不得大于`当前库存`）。
    5.  填写`领用用途`。
    6.  提交。

#### 4.3.2 领出总表 (Outbound History)
* **页面展示**：对应截图2的字段。
* **功能**：记录每一次库存扣减的历史。
* **字段定义与逻辑**：
    | 页面字段 | 逻辑来源 |
    | :--- | :--- |
    | 领出单号 | 系统自动生成 (规则: `LC`+`YYYYMMDD`+`4位流水号`) |
    | 领用人 | 当前登录用户的姓名 |
    | 领出日期 | 系统当前时间 |
    | 领用用途 | 用户填写 |
    | 物料状态 | 初始默认为“使用中” |
    | 有效期 | **快照**：复制领用时刻该批次的有效期 |
    | 使用情况 | 对应截图，用户可操作字段 |

#### 4.3.3 使用反馈 (状态变更)
* **场景**：用户领走了一瓶培养基，这瓶东西在现实中可能用了3天用完了。
* **操作**：
    1.  用户进入“我的领用记录”。
    2.  找到对应记录，点击“标记完成”或“更新进度”。
    3.  系统将`使用情况`字段由“使用中”更新为“使用完”。

---

## 5. 数据模型设计 (Schema)

为支撑上述功能，建议的数据库表结构（ER图概念版）：

### 5.1 `sys_users` (用户表)
* `id`, `username`, `password_hash`, `real_name`, `role`, `status`

### 5.2 `wms_inventory` (库存批次表 - 对应截图1)
* **ID**: Primary Key
* **Material_Info**: `code`, `name`, `type`, `spec`, `unit`, `brand` (为简化开发，可冗余存储，也可拆分基础表)
* **Batch_Info**: `batch_no` (内部批号), `inbound_no` (入库单号)
* **Stock_Info**: `initial_qty` (入库数), `current_qty` (当前剩余), `expiry_date` (有效期)
* **Meta**: `created_at`, `updated_at`

### 5.3 `wms_outbound` (领出记录表 - 对应截图2)
* **ID**: Primary Key
* **Relation**: `inventory_id` (关联库存表ID，以追踪是哪个批次)
* **Order_Info**: `outbound_no`, `apply_date`
* **User_Info**: `user_id`, `user_name`
* **Detail**: `quantity`, `purpose`, `status` (使用中/已用完)
* **Snapshot**: `snap_expiry_date` (冗余存一份有效期，防止源库存被删后无法追溯)

---

## 6. 非功能性需求 (NFR)

1.  **并发控制**：
    * 当库存仅剩1个，且两个人同时点击领用时，需利用数据库事务（Transaction）或乐观锁机制，确保库存不会扣减为负数。
2.  **数据安全性**：
    * 用户密码需加密存储（如 bcrypt）。
    * 敏感操作（如修改库存数量）需记录操作日志。
3.  **移动端适配**：
    * 考虑到实验室场景，领用页面需适配手机/平板浏览器，方便在货架旁直接操作。

---

## 7. 实施路线图 (Roadmap)

1.  **阶段一：数据底座 (Day 1-3)**
    * 完成数据库建表。
    * 完成后端API（登录、增删改查）。
    * 实现Excel解析入库的核心逻辑。

2.  **阶段二：库存核心 (Day 4-7)**
    * 开发“库存总表”页面。
    * 实现效期计算与颜色渲染逻辑。
    * 联调入库功能。

3.  **阶段三：领用闭环 (Day 8-10)**
    * 开发“领用申请”与“领出总表”。
    * 实现库存扣减的事务逻辑。
    * 完善“使用情况”的状态流转。

4.  **阶段四：UI优化与交付 (Day 11-14)**
    * 根据截图优化表格样式。
    * 添加搜索、导出功能。
    * 部署测试。